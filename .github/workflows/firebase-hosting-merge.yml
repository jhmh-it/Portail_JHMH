# ğŸš€ Workflow CD - DÃ©ploiement Production
# DÃ©ploie automatiquement sur Firebase Hosting + Functions quand du code est merged sur main

name: Deploy to Production

on:
  push:
    branches:
      - main
  workflow_dispatch: # Permet dÃ©ploiement manuel
    inputs:
      deploy_functions:
        description: 'DÃ©ployer aussi les Cloud Functions?'
        required: true
        default: true
        type: boolean

env:
  NODE_VERSION: '20'

jobs:
  # ğŸ” VÃ©rifications prÃ©-dÃ©ploiement
  pre-deployment-checks:
    name: ğŸ” Pre-deployment Checks
    runs-on: ubuntu-latest
    timeout-minutes: 10

    outputs:
      should-deploy: ${{ steps.check.outputs.should-deploy }}
      version: ${{ steps.version.outputs.version }}

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ”§ Install Dependencies
        run: npm ci

      - name: ğŸ” Quality Gate Check
        id: check
        run: |
          echo "ğŸ” VÃ©rification des quality gates..."

          # VÃ©rifier si les tests passent
          npm run lint
          npm run type-check
          npm run build

          echo "should-deploy=true" >> $GITHUB_OUTPUT
          echo "âœ… Quality gates passÃ©s"
        env:
          NEXT_PUBLIC_FIREBASE_API_KEY: ${{ secrets.NEXT_PUBLIC_FIREBASE_API_KEY }}
          NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN: ${{ secrets.NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN }}
          NEXT_PUBLIC_FIREBASE_PROJECT_ID: ${{ secrets.NEXT_PUBLIC_FIREBASE_PROJECT_ID }}
          NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET: ${{ secrets.NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET }}
          NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID: ${{ secrets.NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID }}
          NEXT_PUBLIC_FIREBASE_APP_ID: ${{ secrets.NEXT_PUBLIC_FIREBASE_APP_ID }}
          FIREBASE_PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}
          FIREBASE_CLIENT_EMAIL: ${{ secrets.FIREBASE_CLIENT_EMAIL }}
          FIREBASE_PRIVATE_KEY: ${{ secrets.FIREBASE_PRIVATE_KEY }}

      - name: ğŸ“Š Generate Version
        id: version
        run: |
          VERSION=$(date +'%Y.%m.%d')-${GITHUB_SHA:0:7}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ğŸ“Š Version: $VERSION"

  # ğŸ—ï¸ Build de Production
  build-production:
    name: ğŸ—ï¸ Production Build
    runs-on: ubuntu-latest
    needs: pre-deployment-checks
    if: needs.pre-deployment-checks.outputs.should-deploy == 'true'
    timeout-minutes: 15

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ”§ Install Dependencies
        run: npm ci

      - name: ğŸ—ï¸ Build for Production
        run: |
          echo "ğŸ—ï¸ Building for production..."
          npm run build
        env:
          NODE_ENV: production
          NEXT_TELEMETRY_DISABLED: 1
          NEXT_PUBLIC_FIREBASE_API_KEY: ${{ secrets.NEXT_PUBLIC_FIREBASE_API_KEY }}
          NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN: ${{ secrets.NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN }}
          NEXT_PUBLIC_FIREBASE_PROJECT_ID: ${{ secrets.NEXT_PUBLIC_FIREBASE_PROJECT_ID }}
          NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET: ${{ secrets.NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET }}
          NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID: ${{ secrets.NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID }}
          NEXT_PUBLIC_FIREBASE_APP_ID: ${{ secrets.NEXT_PUBLIC_FIREBASE_APP_ID }}
          FIREBASE_PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}
          FIREBASE_CLIENT_EMAIL: ${{ secrets.FIREBASE_CLIENT_EMAIL }}
          FIREBASE_PRIVATE_KEY: ${{ secrets.FIREBASE_PRIVATE_KEY }}

      - name: ğŸ“ Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: production-build
          path: |
            .next
            out
            public
          retention-days: 7

  # ğŸ”’ PrÃ©paration Cloud Functions Node.js
  prepare-functions:
    name: ğŸ”’ Prepare Cloud Functions
    runs-on: ubuntu-latest
    needs: pre-deployment-checks
    if: needs.pre-deployment-checks.outputs.should-deploy == 'true'
    timeout-minutes: 10

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install Functions Dependencies
        working-directory: functions
        run: |
          echo "ğŸ“¦ Installation des dÃ©pendances Node.js Functions..."
          npm ci

      - name: ğŸ§ª Validate Functions
        working-directory: functions
        run: |
          echo "ğŸ§ª Validation des Cloud Functions Node.js..."

          # Build TypeScript
          echo "ğŸ”¨ Build des Cloud Functions..."
          npm run build

          # Tests
          echo "ğŸ§ª Tests des Cloud Functions..."
          npm run test

          # Linting
          echo "ğŸ” Linting des Cloud Functions..."
          npm run lint

      - name: ğŸ“ Upload Functions Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: functions-build
          path: functions/
          retention-days: 7

  # ğŸš€ DÃ©ploiement Production
  deploy-production:
    name: ğŸš€ Deploy to Production
    runs-on: ubuntu-latest
    needs: [pre-deployment-checks, build-production, prepare-functions]
    timeout-minutes: 20
    environment:
      name: production
      url: https://portail-jhmh.web.app

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“ Download Build Artifacts
        uses: actions/download-artifact@v4
        with:
          name: production-build

      - name: ğŸ“ Download Functions Artifacts
        uses: actions/download-artifact@v4
        with:
          name: functions-build
          path: functions/

      - name: ğŸ”§ Install Dependencies
        run: npm ci

      - name: ğŸŒ Deploy Hosting
        uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: ${{ secrets.GITHUB_TOKEN }}
          firebaseServiceAccount: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_PORTAIL_JHMH }}
          channelId: live
          projectId: portail-jhmh

      - name: ğŸ”’ Deploy Cloud Functions
        if: github.event.inputs.deploy_functions != 'false'
        run: |
          echo "ğŸ”’ DÃ©ploiement des Cloud Functions Node.js..."

          # Installation de Firebase CLI
          npm install -g firebase-tools

          # Authentification avec service account
          echo "$FIREBASE_SERVICE_ACCOUNT" > /tmp/service-account.json
          export GOOGLE_APPLICATION_CREDENTIALS=/tmp/service-account.json

          # Installation et build des Cloud Functions
          echo "ğŸ“¦ Installation des dÃ©pendances Functions..."
          cd functions
          npm ci

          echo "ğŸ”¨ Build des Cloud Functions..."
          npm run build

          echo "ğŸ§ª Tests des Cloud Functions..."
          npm run test

          # Retour au rÃ©pertoire racine
          cd ..

          # DÃ©ploiement des functions
          echo "ğŸš€ DÃ©ploiement Firebase Functions..."
          if ! firebase deploy --only functions --project portail-jhmh; then
            echo "âŒ Ã‰chec du dÃ©ploiement des Cloud Functions"
            echo ""
            echo "ğŸ” Diagnostic :"
            echo "Working directory: $(pwd)"
            echo "Node version: $(node --version)"
            echo "NPM version: $(npm --version)"
            echo "Functions directory exists: $(test -d functions && echo 'YES' || echo 'NO')"
            echo "Functions lib directory exists: $(test -d functions/lib && echo 'YES' || echo 'NO')"
            echo ""
            echo "ğŸ” Causes possibles :"
            echo "1. APIs Google Cloud manquantes (cloudbuild.googleapis.com, artifactregistry.googleapis.com)"
            echo "2. Permissions insuffisantes du service account"
            echo "3. Quota Google Cloud dÃ©passÃ©"
            echo "4. Erreur de build ou test des Cloud Functions"
            echo ""
            echo "ğŸ“– Guide de rÃ©solution :"
            echo "   â†’ Voir docs/FIREBASE_APIS_SETUP.md"
            echo "   â†’ Console Google Cloud : https://console.cloud.google.com/apis/dashboard?project=portail-jhmh"
            echo ""
            echo "ğŸš€ Actions recommandÃ©es :"
            echo "   1. Activer Cloud Build API : https://console.cloud.google.com/apis/library/cloudbuild.googleapis.com?project=portail-jhmh"
            echo "   2. Activer Artifact Registry API : https://console.cloud.google.com/apis/library/artifactregistry.googleapis.com?project=portail-jhmh"
            exit 1
          fi

          # Nettoyage
          rm -f /tmp/service-account.json
        env:
          FIREBASE_SERVICE_ACCOUNT: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_PORTAIL_JHMH }}

  # ğŸ§ª Tests Post-DÃ©ploiement
  post-deployment-tests:
    name: ğŸ§ª Post-deployment Tests
    runs-on: ubuntu-latest
    needs: deploy-production
    timeout-minutes: 10

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸŒ Health Check - Hosting
        run: |
          echo "ğŸŒ VÃ©rification du dÃ©ploiement Hosting..."
          response=$(curl -s -o /dev/null -w "%{http_code}" https://portail-jhmh.web.app)
          if [ $response = "200" ]; then
            echo "âœ… Hosting dÃ©ployÃ© avec succÃ¨s"
          else
            echo "âŒ Erreur de dÃ©ploiement Hosting (HTTP $response)"
            exit 1
          fi

      - name: ğŸ”’ Health Check - Functions
        run: |
          echo "ğŸ”’ VÃ©rification des Cloud Functions..."
          # Test de la fonction de health check
          response=$(curl -s -o /dev/null -w "%{http_code}" "https://europe-west1-portail-jhmh.cloudfunctions.net/healthCheck")
          if [ $response = "200" ]; then
            echo "âœ… Cloud Functions dÃ©ployÃ©es avec succÃ¨s"
          else
            echo "âš ï¸ Cloud Functions peuvent ne pas Ãªtre dÃ©ployÃ©es (HTTP $response)"
          fi

      - name: ğŸ“Š Deployment Summary
        run: |
          echo "## ğŸ‰ DÃ©ploiement Production RÃ©ussi" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“‹ DÃ©tails du dÃ©ploiement" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: ${{ needs.pre-deployment-checks.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${GITHUB_SHA:0:7}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branche**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **URL**: https://portail-jhmh.web.app" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âœ… Services dÃ©ployÃ©s" >> $GITHUB_STEP_SUMMARY
          echo "- [x] ğŸŒ Firebase Hosting" >> $GITHUB_STEP_SUMMARY
          echo "- [x] ğŸ”’ Cloud Functions (Auth Restriction)" >> $GITHUB_STEP_SUMMARY

  # ğŸ“¢ Notifications
  notify-deployment:
    name: ğŸ“¢ Notify Deployment
    runs-on: ubuntu-latest
    needs: [deploy-production, post-deployment-tests]
    if: always()

    steps:
      - name: ğŸ‰ Success Notification
        if: needs.deploy-production.result == 'success' && needs.post-deployment-tests.result == 'success'
        run: |
          echo "ğŸ‰ DÃ©ploiement production rÃ©ussi !"
          echo "ğŸŒ URL: https://portail-jhmh.web.app"
          echo "ğŸ“Š Version: ${{ needs.pre-deployment-checks.outputs.version }}"

          # Ici vous pouvez ajouter des notifications Slack, Teams, etc.

      - name: ğŸš¨ Failure Notification
        if: needs.deploy-production.result == 'failure' || needs.post-deployment-tests.result == 'failure'
        run: |
          echo "ğŸš¨ Ã‰chec du dÃ©ploiement production"
          echo "ğŸ”§ VÃ©rifiez les logs ci-dessus"

          # Ici vous pouvez ajouter des notifications d'alerte
