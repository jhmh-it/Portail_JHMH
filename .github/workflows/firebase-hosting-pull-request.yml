# üîç Workflow PR - Preview et Tests
# D√©ploie une preview et valide le code sur chaque Pull Request

name: PR Preview & Validation

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  checks: write
  contents: read
  pull-requests: write

env:
  NODE_VERSION: '20'
  PYTHON_VERSION: '3.11'

jobs:
  # üîç Validation rapide pour feedback imm√©diat
  quick-validation:
    name: üöÄ Quick Validation
    runs-on: ubuntu-latest
    timeout-minutes: 8

    steps:
      - name: üì• Checkout Code
        uses: actions/checkout@v4

      - name: üì¶ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: üîß Install Dependencies
        run: npm ci

      - name: ‚ö° Quick Checks
        run: |
          echo "‚ö° Validation rapide..."
          npm run lint
          npm run type-check

  # üèóÔ∏è Build et Tests Complets
  build-and-test:
    name: üèóÔ∏è Build & Comprehensive Tests
    runs-on: ubuntu-latest
    needs: quick-validation
    timeout-minutes: 15

    outputs:
      build-success: ${{ steps.build.outputs.success }}

    steps:
      - name: üì• Checkout Code
        uses: actions/checkout@v4

      - name: üì¶ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: üîß Install Dependencies
        run: npm ci

      - name: üßπ Linting & Formatting Check
        run: |
          echo "üßπ V√©rification du code..."
          npm run lint
          npm run format:check

      - name: üîç TypeScript Check
        run: npm run type-check

      - name: üèóÔ∏è Build Application
        id: build
        run: |
          echo "üèóÔ∏è Building application..."
          npm run build
          echo "success=true" >> $GITHUB_OUTPUT

      - name: üìÅ Cache Build for Preview
        uses: actions/cache@v4
        with:
          path: |
            .next
            out
            public
          key: ${{ runner.os }}-pr-build-${{ github.event.pull_request.head.sha }}

  # üîí Validation Functions
  validate-functions:
    name: üîí Cloud Functions Validation
    runs-on: ubuntu-latest
    needs: quick-validation
    timeout-minutes: 10

    outputs:
      functions-valid: ${{ steps.validate.outputs.valid }}

    steps:
      - name: üì• Checkout Code
        uses: actions/checkout@v4

      - name: üêç Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: üì¶ Install Functions Dependencies
        working-directory: functions
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install autopep8

      - name: üß™ Validate Functions
        id: validate
        working-directory: functions
        run: |
          echo "üß™ Validation des Cloud Functions..."

          # Formatage Python
          echo "üé® Formatage automatique du code Python..."
          autopep8 --in-place --max-line-length=100 --aggressive main.py

          # Compilation Python
          python -m py_compile main.py

          # Tests de validation si disponibles
          if [ -f "test_validation.py" ]; then
            python test_validation.py
          fi

          # Linting Python
          echo "üîç Linting Python avec flake8..."
          flake8 main.py --max-line-length=100 --ignore=E203,W503 || echo "‚ö†Ô∏è Avertissements de style Python"

          echo "valid=true" >> $GITHUB_OUTPUT
          echo "‚úÖ Cloud Functions valid√©es"

  # üåê D√©ploiement Preview
  deploy-preview:
    name: üåê Deploy Preview
    if: github.event.pull_request.head.repo.full_name == github.repository
    runs-on: ubuntu-latest
    needs: [build-and-test, validate-functions]
    timeout-minutes: 15

    outputs:
      preview-url: ${{ steps.deploy.outputs.details_url }}

    steps:
      - name: üì• Checkout Code
        uses: actions/checkout@v4

      - name: üì¶ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: üîß Install Dependencies
        run: npm ci

      - name: üìÅ Restore Build Cache
        uses: actions/cache@v4
        with:
          path: |
            .next
            out
            public
          key: ${{ runner.os }}-pr-build-${{ github.event.pull_request.head.sha }}

      - name: üèóÔ∏è Build if Cache Miss
        run: |
          if [ ! -d ".next" ]; then
            echo "üèóÔ∏è Cache miss, rebuilding..."
            npm run build
          else
            echo "‚úÖ Using cached build"
          fi

      - name: üåê Deploy to Preview
        id: deploy
        uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: ${{ secrets.GITHUB_TOKEN }}
          firebaseServiceAccount: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_PORTAIL_JHMH }}
          projectId: portail-jhmh
          expires: 7d

  # üß™ Tests E2E sur Preview
  e2e-tests:
    name: üß™ E2E Tests on Preview
    runs-on: ubuntu-latest
    needs: deploy-preview
    if: needs.deploy-preview.outputs.preview-url
    timeout-minutes: 10

    steps:
      - name: üì• Checkout Code
        uses: actions/checkout@v4

      - name: üåê Basic Smoke Tests
        run: |
          PREVIEW_URL="${{ needs.deploy-preview.outputs.preview-url }}"
          echo "üß™ Testing preview: $PREVIEW_URL"

          # Test basique de chargement
          response=$(curl -s -o /dev/null -w "%{http_code}" "$PREVIEW_URL")
          if [ $response = "200" ]; then
            echo "‚úÖ Preview accessible"
          else
            echo "‚ùå Preview inaccessible (HTTP $response)"
            exit 1
          fi

          # Test des routes principales
          routes=("/" "/login")
          for route in "${routes[@]}"; do
            response=$(curl -s -o /dev/null -w "%{http_code}" "$PREVIEW_URL$route")
            if [ $response = "200" ]; then
              echo "‚úÖ Route $route OK"
            else
              echo "‚ö†Ô∏è Route $route: HTTP $response"
            fi
          done

  # üìä Analyse de Performance
  performance-analysis:
    name: üìä Performance Analysis
    runs-on: ubuntu-latest
    needs: deploy-preview
    if: needs.deploy-preview.outputs.preview-url
    timeout-minutes: 10

    steps:
      - name: üì• Checkout Code
        uses: actions/checkout@v4

      - name: üì¶ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: üîß Install Lighthouse
        run: npm install -g lighthouse

      - name: üöÄ Lighthouse Analysis
        run: |
          PREVIEW_URL="${{ needs.deploy-preview.outputs.preview-url }}"
          echo "üöÄ Analyse Lighthouse: $PREVIEW_URL"

          lighthouse "$PREVIEW_URL" \
            --output=json \
            --output-path=./lighthouse-results.json \
            --chrome-flags="--headless --no-sandbox" \
            --quiet

      - name: üìä Extract Performance Metrics
        run: |
          if [ -f "./lighthouse-results.json" ]; then
            node -e "
              const results = JSON.parse(require('fs').readFileSync('./lighthouse-results.json'));
              const scores = results.lhr.categories;
              
              console.log('üìä **Performance Scores:**');
              console.log('- Performance:', Math.round(scores.performance.score * 100));
              console.log('- Accessibility:', Math.round(scores.accessibility.score * 100));
              console.log('- Best Practices:', Math.round(scores['best-practices'].score * 100));
              console.log('- SEO:', Math.round(scores.seo.score * 100));
            " > performance-summary.txt
            
            cat performance-summary.txt
          fi

  # üí¨ Commentaire R√©sum√© PR
  pr-summary:
    name: üí¨ PR Summary Comment
    runs-on: ubuntu-latest
    needs:
      [
        build-and-test,
        validate-functions,
        deploy-preview,
        e2e-tests,
        performance-analysis,
      ]
    if: always()

    steps:
      - name: üí¨ Update PR Comment
        uses: actions/github-script@v7
        with:
          script: |
            const buildSuccess = '${{ needs.build-and-test.outputs.build-success }}' === 'true';
            const functionsValid = '${{ needs.validate-functions.outputs.functions-valid }}' === 'true';
            const previewUrl = '${{ needs.deploy-preview.outputs.preview-url }}';
            const e2eSuccess = '${{ needs.e2e-tests.result }}' === 'success';

            let body = `## üîç PR Preview & Validation Results\n\n`;

            body += `### ‚úÖ Checks\n`;
            body += `- ${buildSuccess ? '‚úÖ' : '‚ùå'} Build & TypeScript\n`;
            body += `- ${functionsValid ? '‚úÖ' : '‚ùå'} Cloud Functions Validation\n`;
            body += `- ${e2eSuccess ? '‚úÖ' : '‚ùå'} E2E Tests\n\n`;

            if (previewUrl) {
              body += `### üåê Preview Deployment\n`;
              body += `üîó **Preview URL**: ${previewUrl}\n\n`;
              body += `*Preview expires in 7 days*\n\n`;
            }

            body += `### üìä Quality Gate\n`;
            if (buildSuccess && functionsValid) {
              body += `üéâ **Ready to merge!** All quality checks passed.\n`;
            } else {
              body += `üîß **Issues detected** - Please address the failing checks above.\n`;
            }

            // Trouver le commentaire existant ou en cr√©er un nouveau
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const existingComment = comments.data.find(
              comment => comment.user.type === 'Bot' && comment.body.includes('üîç PR Preview & Validation Results')
            );

            if (existingComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existingComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }
