# ğŸš§ Workflow Staging - Environnement de Test
# DÃ©ploie sur l'environnement staging pour validation avant production

name: Deploy to Staging

on:
  push:
    branches: [develop]
  workflow_dispatch:
    inputs:
      force_deploy:
        description: 'Forcer le dÃ©ploiement mÃªme si les tests Ã©chouent'
        required: false
        default: false
        type: boolean

env:
  NODE_VERSION: '20'
  PYTHON_VERSION: '3.11'
  FIREBASE_PROJECT_STAGING: 'portail-jhmh-staging' # Projet Firebase staging

jobs:
  # ğŸ” Validation prÃ©-staging
  pre-staging-validation:
    name: ğŸ” Pre-staging Validation
    runs-on: ubuntu-latest
    timeout-minutes: 12

    outputs:
      should-deploy: ${{ steps.validate.outputs.deploy }}
      version: ${{ steps.version.outputs.version }}

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ”§ Install Dependencies
        run: npm ci

      - name: ğŸ” Full Validation Suite
        id: validate
        run: |
          echo "ğŸ” Suite complÃ¨te de validation..."

          # Linting et formatage
          npm run lint
          npm run format:check

          # Type checking
          npm run type-check

          # Build
          npm run build

          # Audit de sÃ©curitÃ©
          npm audit --audit-level=moderate || echo "âš ï¸ VulnÃ©rabilitÃ©s dÃ©tectÃ©es"

          echo "deploy=true" >> $GITHUB_OUTPUT
          echo "âœ… Validation staging rÃ©ussie"
        env:
          NEXT_PUBLIC_FIREBASE_API_KEY: ${{ secrets.NEXT_PUBLIC_FIREBASE_API_KEY }}
          NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN: ${{ secrets.NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN }}
          NEXT_PUBLIC_FIREBASE_PROJECT_ID: ${{ secrets.NEXT_PUBLIC_FIREBASE_PROJECT_ID }}
          NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET: ${{ secrets.NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET }}
          NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID: ${{ secrets.NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID }}
          NEXT_PUBLIC_FIREBASE_APP_ID: ${{ secrets.NEXT_PUBLIC_FIREBASE_APP_ID }}
          FIREBASE_PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}
          FIREBASE_CLIENT_EMAIL: ${{ secrets.FIREBASE_CLIENT_EMAIL }}
          FIREBASE_PRIVATE_KEY: ${{ secrets.FIREBASE_PRIVATE_KEY }}

      - name: ğŸ·ï¸ Generate Staging Version
        id: version
        run: |
          STAGING_VERSION="staging-$(date +'%Y.%m.%d')-${GITHUB_SHA:0:7}"
          echo "version=$STAGING_VERSION" >> $GITHUB_OUTPUT
          echo "ğŸ·ï¸ Version staging: $STAGING_VERSION"

  # ğŸ”’ Validation Functions pour Staging
  validate-functions-staging:
    name: ğŸ”’ Functions Staging Validation
    runs-on: ubuntu-latest
    needs: pre-staging-validation
    timeout-minutes: 10

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ğŸ“¦ Install Dependencies
        working-directory: functions
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install autopep8

      - name: ğŸ§ª Comprehensive Function Tests
        working-directory: functions
        run: |
          echo "ğŸ§ª Tests complets des Cloud Functions..."

          # Formatage Python
          echo "ğŸ¨ Formatage automatique du code Python..."
          autopep8 --in-place --max-line-length=100 --aggressive main.py

          # Linting Python
          echo "ğŸ” Linting Python avec flake8..."
          flake8 main.py --max-line-length=100 --ignore=E203,W503

          # Tests de validation
          if [ -f "test_validation.py" ]; then
            python test_validation.py
          fi

          # Tests de sÃ©curitÃ© spÃ©cifiques
          echo "ğŸ” Tests de sÃ©curitÃ© domaine..."
          python -c "
          from main import is_email_allowed

          # Tests de sÃ©curitÃ© avancÃ©s
          security_tests = [
              ('user@jhmh.com.malicious.com', False),
              ('admin@jhmh.com', True),
              ('test+tag@jhmh.com', True),
              ('user@JHMH.COM', True),
              ('', False),
              (None, False)
          ]

          for email, expected in security_tests:
              result = is_email_allowed(email)
              assert result == expected, f'Security test failed for {email}'

          print('âœ… Tests de sÃ©curitÃ© passÃ©s')
          "

  # ğŸ—ï¸ Build Staging
  build-staging:
    name: ğŸ—ï¸ Staging Build
    runs-on: ubuntu-latest
    needs: [pre-staging-validation, validate-functions-staging]
    if: needs.pre-staging-validation.outputs.should-deploy == 'true'
    timeout-minutes: 15

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ”§ Install Dependencies
        run: npm ci

      - name: ğŸ—ï¸ Build for Staging
        run: |
          echo "ğŸ—ï¸ Building for staging environment..."
          npm run build
        env:
          NODE_ENV: production
          NEXT_PUBLIC_ENV: staging
          NEXT_TELEMETRY_DISABLED: 1
          NEXT_PUBLIC_FIREBASE_API_KEY: ${{ secrets.NEXT_PUBLIC_FIREBASE_API_KEY }}
          NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN: ${{ secrets.NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN }}
          NEXT_PUBLIC_FIREBASE_PROJECT_ID: ${{ secrets.NEXT_PUBLIC_FIREBASE_PROJECT_ID }}
          NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET: ${{ secrets.NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET }}
          NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID: ${{ secrets.NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID }}
          NEXT_PUBLIC_FIREBASE_APP_ID: ${{ secrets.NEXT_PUBLIC_FIREBASE_APP_ID }}
          FIREBASE_PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}
          FIREBASE_CLIENT_EMAIL: ${{ secrets.FIREBASE_CLIENT_EMAIL }}
          FIREBASE_PRIVATE_KEY: ${{ secrets.FIREBASE_PRIVATE_KEY }}

      - name: ğŸ“ Upload Staging Build
        uses: actions/upload-artifact@v4
        with:
          name: staging-build
          path: |
            .next
            out
            public
          retention-days: 7

  # ğŸš§ DÃ©ploiement Staging
  deploy-staging:
    name: ğŸš§ Deploy to Staging
    runs-on: ubuntu-latest
    needs: [pre-staging-validation, build-staging]
    timeout-minutes: 20
    environment:
      name: staging
      url: https://portail-jhmh-staging.web.app

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ğŸ“ Download Build Artifacts
        uses: actions/download-artifact@v4
        with:
          name: staging-build

      - name: ğŸ”§ Install Dependencies
        run: |
          npm ci
          npm install -g firebase-tools

      - name: ğŸ” Setup Firebase Authentication
        run: |
          echo "ğŸ” Configuration de l'authentification Firebase..."
          echo "$FIREBASE_SERVICE_ACCOUNT" > /tmp/service-account.json
          export GOOGLE_APPLICATION_CREDENTIALS=/tmp/service-account.json
          echo "GOOGLE_APPLICATION_CREDENTIALS=/tmp/service-account.json" >> $GITHUB_ENV
        env:
          FIREBASE_SERVICE_ACCOUNT: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_PORTAIL_JHMH }}

      - name: ğŸŒ Deploy Hosting to Staging
        run: |
          echo "ğŸŒ DÃ©ploiement Hosting vers staging..."
          firebase deploy --only hosting --project ${{ env.FIREBASE_PROJECT_STAGING }}

      - name: ğŸ”’ Deploy Functions to Staging
        run: |
          echo "ğŸ”’ DÃ©ploiement Functions Node.js vers staging..."

          # Installation et build des Cloud Functions
          echo "ğŸ“¦ Installation des dÃ©pendances Functions..."
          cd functions
          npm ci

          echo "ğŸ”¨ Build des Cloud Functions..."
          npm run build

          echo "ğŸ§ª Tests des Cloud Functions..."
          npm run test

          # Retour au rÃ©pertoire racine
          cd ..

          # DÃ©ploiement vers staging
          echo "ğŸš€ DÃ©ploiement Firebase Functions vers staging..."
          firebase deploy --only functions --project ${{ env.FIREBASE_PROJECT_STAGING }}

      - name: ğŸ§¹ Cleanup Firebase Auth
        if: always()
        run: |
          rm -f /tmp/service-account.json

  # ğŸ§ª Tests d'IntÃ©gration Staging
  integration-tests:
    name: ğŸ§ª Staging Integration Tests
    runs-on: ubuntu-latest
    needs: deploy-staging
    timeout-minutes: 15

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸŒ Health Checks
        run: |
          echo "ğŸŒ VÃ©rifications de santÃ© staging..."

          STAGING_URL="https://portail-jhmh-staging.web.app"

          # Test de base
          response=$(curl -s -o /dev/null -w "%{http_code}" "$STAGING_URL")
          if [ $response = "200" ]; then
            echo "âœ… Staging hosting accessible"
          else
            echo "âŒ Staging hosting inaccessible (HTTP $response)"
            exit 1
          fi

          # Test des pages critiques
          critical_pages=("/" "/login")
          for page in "${critical_pages[@]}"; do
            response=$(curl -s -o /dev/null -w "%{http_code}" "$STAGING_URL$page")
            if [ $response = "200" ]; then
              echo "âœ… Page $page accessible"
            else
              echo "âš ï¸ Page $page: HTTP $response"
            fi
          done

      - name: ğŸ”’ Function Health Check
        run: |
          echo "ğŸ”’ Test des Cloud Functions staging..."

          # Test de la fonction de validation
          FUNCTION_URL="https://europe-west1-portail-jhmh-staging.cloudfunctions.net/test_domain_check"

          # Test email autorisÃ©
          response=$(curl -s "$FUNCTION_URL?email=test@jhmh.com")
          if echo "$response" | grep -q "autorisÃ©"; then
            echo "âœ… Function validation OK pour email autorisÃ©"
          else
            echo "âš ï¸ Function validation: $response"
          fi

          # Test email non autorisÃ©
          response=$(curl -s "$FUNCTION_URL?email=test@gmail.com")
          if echo "$response" | grep -q "bloquÃ©"; then
            echo "âœ… Function validation OK pour email bloquÃ©"
          else
            echo "âš ï¸ Function validation: $response"
          fi

      - name: âš¡ Performance Tests
        run: |
          echo "âš¡ Tests de performance staging..."

          STAGING_URL="https://portail-jhmh-staging.web.app"

          # Test de temps de rÃ©ponse
          start_time=$(date +%s%N)
          curl -s "$STAGING_URL" > /dev/null
          end_time=$(date +%s%N)

          response_time=$((($end_time - $start_time) / 1000000)) # en millisecondes

          echo "ğŸ“Š Temps de rÃ©ponse: ${response_time}ms"

          if [ $response_time -lt 3000 ]; then
            echo "âœ… Performance acceptable (< 3s)"
          else
            echo "âš ï¸ Performance lente (> 3s)"
          fi

  # ğŸ“Š Rapport de Staging
  staging-report:
    name: ğŸ“Š Staging Deployment Report
    runs-on: ubuntu-latest
    needs: [deploy-staging, integration-tests]
    if: always()

    steps:
      - name: ğŸ“Š Generate Report
        run: |
          echo "## ğŸš§ Rapport de DÃ©ploiement Staging" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“‹ Informations" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: ${{ needs.pre-staging-validation.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branche**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${GITHUB_SHA:0:7}" >> $GITHUB_STEP_SUMMARY
          echo "- **URL Staging**: https://portail-jhmh-staging.web.app" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### âœ… Status" >> $GITHUB_STEP_SUMMARY
          if [ "${{ needs.deploy-staging.result }}" = "success" ] && [ "${{ needs.integration-tests.result }}" = "success" ]; then
            echo "ğŸ‰ **DÃ©ploiement staging rÃ©ussi !**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- [x] ğŸŒ Hosting dÃ©ployÃ©" >> $GITHUB_STEP_SUMMARY
            echo "- [x] ğŸ”’ Functions dÃ©ployÃ©es" >> $GITHUB_STEP_SUMMARY
            echo "- [x] ğŸ§ª Tests d'intÃ©gration passÃ©s" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âœ… **PrÃªt pour validation et dÃ©ploiement production**" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **ProblÃ¨mes dÃ©tectÃ©s en staging**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ğŸ”§ VÃ©rifiez les logs des jobs ci-dessus" >> $GITHUB_STEP_SUMMARY
          fi

      - name: ğŸ”” Notify Team
        if: needs.deploy-staging.result == 'success' && needs.integration-tests.result == 'success'
        run: |
          echo "ğŸ”” Notification Ã©quipe: Staging dÃ©ployÃ© avec succÃ¨s"
          echo "ğŸ“‹ Version: ${{ needs.pre-staging-validation.outputs.version }}"
          echo "ğŸŒ URL: https://portail-jhmh-staging.web.app"

          # Ici vous pouvez ajouter des notifications Slack, Teams, etc.
          # curl -X POST -H 'Content-type: application/json' --data '{"text":"ğŸš§ Staging dÃ©ployÃ©: ${{ needs.pre-staging-validation.outputs.version }}"}' $SLACK_WEBHOOK
