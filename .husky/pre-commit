#!/bin/sh
# ðŸ”’ Pre-commit Hook - VÃ©rifications de QualitÃ©
# ExÃ©cute les vÃ©rifications de qualitÃ© avant chaque commit

echo "ðŸ”’ Pre-commit hook: VÃ©rifications de qualitÃ©..."

# Couleurs pour les messages
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Fonction pour les messages colorÃ©s
print_step() {
    echo "${BLUE}ðŸ” $1${NC}"
}

print_success() {
    echo "${GREEN}âœ… $1${NC}"
}

print_warning() {
    echo "${YELLOW}âš ï¸ $1${NC}"
}

print_error() {
    echo "${RED}âŒ $1${NC}"
}

# VÃ©rifier si nous sommes dans un repo Git
if ! git rev-parse --git-dir > /dev/null 2>&1; then
    print_error "Pas dans un dÃ©pÃ´t Git"
    exit 1
fi

# 1. Lint-staged sur les fichiers modifiÃ©s
print_step "ExÃ©cution de lint-staged..."
if npx lint-staged; then
    print_success "Lint-staged terminÃ© avec succÃ¨s"
else
    print_error "Lint-staged a Ã©chouÃ©"
    echo "${YELLOW}ðŸ’¡ Conseil: Corrigez les erreurs de linting ci-dessus avant de commiter${NC}"
    exit 1
fi

# 2. VÃ©rification TypeScript
print_step "VÃ©rification TypeScript..."
if npm run type-check > /dev/null 2>&1; then
    print_success "Types TypeScript valides"
else
    print_error "Erreurs TypeScript dÃ©tectÃ©es"
    echo "${YELLOW}ðŸ’¡ Conseil: ExÃ©cutez 'npm run type-check' pour voir les dÃ©tails${NC}"
    exit 1
fi

# 3. Test du build (rapide)
print_step "Test de build..."
if npm run build > /dev/null 2>&1; then
    print_success "Build rÃ©ussi"
    # Nettoyer les fichiers de build pour Ã©viter de les commiter
    rm -rf .next/cache 2>/dev/null || true
else
    print_error "Build Ã©chouÃ©"
    echo "${YELLOW}ðŸ’¡ Conseil: ExÃ©cutez 'npm run build' pour voir les dÃ©tails${NC}"
    exit 1
fi

# 4. VÃ©rification des Cloud Functions si modifiÃ©es
if git diff --cached --name-only | grep -q "^functions/"; then
    print_step "VÃ©rification des Cloud Functions..."
    
    if [ -f "functions/main.py" ]; then
        cd functions
        
        # VÃ©rifier la compilation Python
        if python3 -m py_compile main.py 2>/dev/null; then
            print_success "Cloud Functions: compilation OK"
        else
            print_error "Cloud Functions: erreur de compilation"
            cd ..
            exit 1
        fi
        
        # Lancer les tests de validation si disponibles
        if [ -f "test_validation.py" ]; then
            if python3 test_validation.py > /dev/null 2>&1; then
                print_success "Cloud Functions: tests OK"
            else
                print_warning "Cloud Functions: tests ont Ã©chouÃ©"
                echo "${YELLOW}ðŸ’¡ Conseil: VÃ©rifiez 'cd functions && python3 test_validation.py'${NC}"
            fi
        fi
        
        cd ..
    fi
fi

# 5. VÃ©rification des secrets (basique)
print_step "VÃ©rification des secrets..."
secrets_patterns="FIREBASE_PRIVATE_KEY FIREBASE_CLIENT_EMAIL API_KEY SECRET_KEY PASSWORD TOKEN"

for pattern in $secrets_patterns; do
    if git diff --cached | grep -i "$pattern" > /dev/null; then
        print_warning "Possible secret dÃ©tectÃ©: $pattern"
        echo "${YELLOW}ðŸ’¡ Assurez-vous que ce n'est pas un vrai secret${NC}"
    fi
done

# 6. VÃ©rification de la taille des fichiers
print_step "VÃ©rification de la taille des fichiers..."
large_files=$(git diff --cached --name-only | xargs -I {} find {} -size +1M 2>/dev/null || true)
if [ -n "$large_files" ]; then
    print_warning "Fichiers volumineux dÃ©tectÃ©s (>1MB):"
    echo "$large_files"
    echo "${YELLOW}ðŸ’¡ Conseil: ConsidÃ©rez Git LFS pour les gros fichiers${NC}"
fi

# 7. VÃ©rification du message de commit (prÃ©paration)
if [ -n "$HUSKY_GIT_PARAMS" ]; then
    commit_msg_file="$1"
    if [ -f "$commit_msg_file" ]; then
        commit_msg=$(cat "$commit_msg_file")
        if [ ${#commit_msg} -lt 10 ]; then
            print_warning "Message de commit trÃ¨s court"
            echo "${YELLOW}ðŸ’¡ Conseil: Utilisez des messages descriptifs${NC}"
        fi
    fi
fi

print_success "Toutes les vÃ©rifications pre-commit sont passÃ©es !"
echo "${GREEN}ðŸŽ‰ PrÃªt Ã  commiter !${NC}"
