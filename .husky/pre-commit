echo "ğŸ”’ Pre-commit hook: VÃ©rifications de qualitÃ©..."

# ğŸ” ExÃ©cution de lint-staged
echo "ğŸ” ExÃ©cution de lint-staged..."
npx lint-staged

# ğŸ” VÃ©rification TypeScript
echo "ğŸ” VÃ©rification TypeScript..."
npm run type-check || {
  echo "âŒ Erreurs TypeScript dÃ©tectÃ©es"
  echo "ğŸ’¡ Conseil: ExÃ©cutez 'npm run type-check' pour voir les dÃ©tails"
  exit 1
}

echo "âœ… Types TypeScript valides"

# ğŸ—ï¸ Test de build
echo "ğŸ” Test de build..."
npm run build > /dev/null 2>&1 || {
  echo "âŒ Ã‰chec du build"
  echo "ğŸ’¡ Conseil: ExÃ©cutez 'npm run build' pour voir les dÃ©tails"
  exit 1
}

echo "âœ… Build rÃ©ussi"

# ğŸ”’ VÃ©rification des Cloud Functions Node.js
echo "ğŸ” VÃ©rification des Cloud Functions..."
if [ -d "functions" ]; then
  cd functions
  
  # Installation des dÃ©pendances si nÃ©cessaire
  if [ ! -d "node_modules" ]; then
    echo "ğŸ“¦ Installation des dÃ©pendances Functions..."
    npm ci > /dev/null 2>&1
  fi
  
  # Build des Cloud Functions
  echo "ğŸ”¨ Build des Cloud Functions..."
  npm run build > /dev/null 2>&1 || {
    echo "âŒ Ã‰chec du build des Cloud Functions"
    echo "ğŸ’¡ Conseil: cd functions && npm run build"
    exit 1
  }
  
  # Tests des Cloud Functions
  echo "ğŸ§ª Tests des Cloud Functions..."
  npm run test > /dev/null 2>&1 || {
    echo "âŒ Ã‰chec des tests des Cloud Functions"
    echo "ğŸ’¡ Conseil: cd functions && npm run test"
    exit 1
  }
  
  cd ..
  echo "âœ… Cloud Functions validÃ©es"
else
  echo "âš ï¸ RÃ©pertoire functions non trouvÃ©"
fi

# ğŸ” VÃ©rification des secrets
echo "ğŸ” VÃ©rification des secrets..."
if grep -r "sk-" . --exclude-dir=node_modules --exclude-dir=.git --exclude-dir=.next --exclude-dir=out 2>/dev/null; then
  echo "âš ï¸ Possible secret dÃ©tectÃ©: TOKEN"
  echo "ğŸ’¡ Assurez-vous que ce n'est pas un vrai secret"
fi

# ğŸ“Š VÃ©rification de la taille des fichiers
echo "ğŸ” VÃ©rification de la taille des fichiers..."
find . -type f -size +10M \
  -not -path "./node_modules/*" \
  -not -path "./.git/*" \
  -not -path "./.next/*" \
  -not -path "./out/*" \
  -not -path "./functions/node_modules/*" \
  -not -path "./functions/lib/*" \
  2>/dev/null | while read file; do
  echo "âš ï¸ Fichier volumineux dÃ©tectÃ©: $file"
done

echo "âœ… Toutes les vÃ©rifications pre-commit sont passÃ©es !"
echo "ğŸ‰ PrÃªt Ã  commiter !"
