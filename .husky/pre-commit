#!/bin/bash

echo "🔍 Running pre-commit checks..."

# Vérifier les fichiers sensibles
echo "🔒 Checking for sensitive files..."
if git diff --cached --name-only | grep -E "(\.env|\.env\.local|\.env\.production|firebase-admin.*\.json|serviceAccount.*\.json)$"; then
  echo "❌ ERROR: Attempting to commit sensitive files!"
  echo "🚫 Please remove .env files and service account keys from your commit"
  exit 1
fi

# Détection basique de secrets
echo "🔍 Scanning for potential secrets..."
STAGED_FILES=$(git diff --cached --name-only)
for file in $STAGED_FILES; do
  if [ -f "$file" ]; then
    # Vérifier les patterns de secrets courants
    if grep -E "(PRIVATE_KEY|SECRET|PASSWORD|API_KEY|private_key|secret|password|api_key)(\s)*[:=](\s)*[\"\'][^\"\']+[\"\']" "$file" 2>/dev/null | grep -v "process\.env\." | grep -v "NEXT_PUBLIC_"; then
      echo "❌ ERROR: Potential secret detected in $file"
      echo "🚫 Please use environment variables for sensitive data"
      exit 1
    fi
  fi
done

# Exécuter lint-staged
echo "✅ Running lint-staged..."
npx lint-staged

echo "✅ Pre-commit checks passed!"
