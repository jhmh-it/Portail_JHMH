# üë• Guests Module - Documentation Technique

## üéØ Vue d'ensemble

Module de gestion des invit√©s et clients permettant la consultation, la recherche et l'affichage d√©taill√© des informations des guests.

### Fonctionnalit√©s principales
- **Recherche avanc√©e** : Filtrage par nom, email, t√©l√©phone, ID, code de confirmation
- **Liste pagin√©e** : Affichage optimis√© avec pagination c√¥t√© serveur
- **D√©tails complets** : Vue d√©taill√©e de chaque invit√©
- **Statuts visuels** : Badges pour VIP, blacklist√©, r√©current
- **Architecture modulaire** : Feature-based avec s√©paration des concerns

## üèóÔ∏è Architecture

```
src/app/home/exploitation/guests/
‚îú‚îÄ‚îÄ page.tsx                    # Page principale - Liste des guests
‚îú‚îÄ‚îÄ [guestId]/                  # Route dynamique
‚îÇ   ‚îî‚îÄ‚îÄ page.tsx               # Page d√©tails d'un guest
‚îú‚îÄ‚îÄ components/                 # Composants UI sp√©cifiques
‚îÇ   ‚îú‚îÄ‚îÄ GuestsTable.tsx        # Table avec pagination
‚îÇ   ‚îú‚îÄ‚îÄ GuestsFilters.tsx     # Interface de filtrage
‚îÇ   ‚îî‚îÄ‚îÄ index.ts               # Export barrel
‚îú‚îÄ‚îÄ config/                     # Configuration centralis√©e
‚îÇ   ‚îú‚îÄ‚îÄ constants.ts           # Constantes (titres, cache, API)
‚îÇ   ‚îî‚îÄ‚îÄ index.ts              
‚îú‚îÄ‚îÄ hooks/                      # Logique m√©tier r√©active
‚îÇ   ‚îú‚îÄ‚îÄ useGuests.ts           # Hook principal pour la liste
‚îÇ   ‚îú‚îÄ‚îÄ useGuestDetails.ts    # Hook pour les d√©tails
‚îÇ   ‚îú‚îÄ‚îÄ useGuestsFilters.ts   # Gestion des filtres
‚îÇ   ‚îî‚îÄ‚îÄ index.ts              
‚îú‚îÄ‚îÄ lib/                        # Utilitaires sp√©cifiques
‚îÇ   ‚îú‚îÄ‚îÄ guests-utils.ts       # Formatage, calculs
‚îÇ   ‚îî‚îÄ‚îÄ index.ts              
‚îú‚îÄ‚îÄ services/                   # Couche API
‚îÇ   ‚îú‚îÄ‚îÄ guests.service.ts     # Service API JHMH
‚îÇ   ‚îî‚îÄ‚îÄ index.ts              
‚îú‚îÄ‚îÄ types/                      # Types TypeScript
‚îÇ   ‚îú‚îÄ‚îÄ guest.ts               # Interfaces Guest
‚îÇ   ‚îú‚îÄ‚îÄ index.ts              
‚îî‚îÄ‚îÄ validation/                 # Validation des donn√©es
    ‚îú‚îÄ‚îÄ guests.validation.ts   # Sch√©mas Zod
    ‚îî‚îÄ‚îÄ index.ts
```

## üì¶ D√©pendances

### D√©pendances externes
```typescript
// Composants globaux
@/components/dashboard         // DashboardLayout, PageHeader
@/components/states           // LoadingVariants, ErrorVariants, NoDataVariants
@/components/ui               // Button, Card, Table, Input, Badge, etc.

// Stores
@/stores/loading-store        // Gestion du loading global

// Utilitaires
@/lib/jhmh-api               // Client API JHMH (axios-based)
@/lib/utils                  // cn, formatters

// Biblioth√®ques
@tanstack/react-query        // Cache et requ√™tes
lucide-react                 // Ic√¥nes
date-fns                     // Manipulation dates
zod                         // Validation
```

### D√©pendances internes
```typescript
// Configuration
./config/constants           // PAGE_CONFIGS, BREADCRUMBS, CACHE_CONFIG, QUERY_KEYS

// Hooks
./hooks/useGuests           // Hook de donn√©es principal
./hooks/useGuestsFilters   // Hook de gestion des filtres
./hooks/useGuestDetails     // Hook pour d√©tails

// Services
./services/guests.service   // API calls

// Types
./types/guest              // Guest, GuestFilters, ExternalGuestsResponse

// Utils
./lib/guests-utils         // formatPhone, formatGuestName, etc.

// Validation
./validation/guests.validation // Sch√©mas Zod pour validation
```

## üîÑ Flux de donn√©es

```mermaid
graph TD
    A[page.tsx] --> B[useGuestsFilters]
    A --> C[useGuests]
    B --> D[Filters State]
    C --> E[guests.service]
    E --> F[jhmhApiClient]
    F --> G[API: /api/guestymirror/guests]
    G --> F
    F --> E
    E --> H[TanStack Query Cache]
    H --> C
    C --> A
    A --> I[GuestsFilters]
    A --> J[GuestsTable]
```

## üé® Composants

### `page.tsx`
**Responsabilit√©** : Page principale orchestrant l'affichage de la liste
```typescript
// √âtats g√©r√©s via hooks
- filters: GuestFilters (via useGuestsFilters)
- guests: Guest[] (via useGuests)
- isLoading, error, refetch (via useGuests)
```

### `GuestsTable`
**Responsabilit√©** : Affichage tabulaire avec pagination
```typescript
interface GuestsTableProps {
  guests: Guest[]
  currentPage: number
  pageSize: number
  total: number
  onPageChange: (page: number) => void
}

// Features
- Affichage responsive
- Pagination avanc√©e
- Actions par ligne
- Badges de statut
```

### `GuestsFilters`
**Responsabilit√©** : Interface de recherche et filtrage
```typescript
interface GuestsFiltersProps {
  filters: GuestFilters
  hasActiveFilters: boolean
  activeFiltersCount: number
  showFilters: boolean
  isRefreshing: boolean
  onSearchChange: (value: string) => void
  onFilterChange: (key: keyof GuestFilters, value: any) => void
  onToggleFilters: () => void
  onResetFilters: () => void
  onRefresh: () => void
}

// Features
- Recherche temps r√©el
- Filtres avanc√©s (ID, code confirmation)
- Compteur de filtres actifs
- Reset des filtres
```

## üîå API & Services

### Endpoint principal
```typescript
GET /api/guestymirror/guests

// Query params
- page: number
- page_size: number
- q: string (recherche)
- guest_id: string
- confirmation_code: string

// Response
{
  data: Guest[]
  error: boolean
  message: string
  meta: {
    filters_applied: Record<string, unknown>
    page: number
    page_size: number
    total: number
    total_pages: number
  }
  timestamp: string
}
```

### Types de donn√©es
```typescript
interface Guest {
  id: string
  full_name?: string
  first_name?: string
  last_name?: string
  email?: string
  phone?: string
  address?: string
  city?: string
  postal_code?: string
  country?: string
  vip_status?: boolean
  blacklisted?: boolean
  is_returning?: boolean
  // ... et plus
}

interface GuestFilters {
  q: string
  page: number
  page_size: number
  guest_id?: string
  confirmation_code?: string
}
```

### Configuration du cache
```typescript
CACHE_CONFIG.GUESTS = {
  revalidate: 60,            // 1 minute (Next.js)
  staleTime: 1 * 60 * 1000,  // 1 minute (React Query)
  gcTime: 5 * 60 * 1000     // 5 minutes (garbage collection)
}
```

## üéØ √âtats de l'interface

### 1. √âtat de chargement
- Utilise `LoadingVariants.Data`
- Affichage d'un spinner avec message

### 2. √âtat d'erreur
- Utilise `ErrorVariants.Card`
- Message d'erreur contextualis√©
- Bouton "R√©essayer"

### 3. √âtat sans donn√©es
- `NoDataVariants.Criteria` si filtres actifs
- `NoDataVariants.Empty` sinon
- Messages appropri√©s selon le contexte

### 4. √âtat succ√®s
- Affichage de la table avec pagination
- Badges de statut pour chaque guest
- Actions disponibles par ligne

## üßÆ Utilitaires (lib/)

### `guests-utils.ts`
```typescript
// Formatage
formatPhone(phone: string): string          // Format t√©l√©phone FR
formatGuestName(guest: Guest): string       // Nom complet
formatAddress(guest: Guest): string         // Adresse compl√®te
getGuestInitials(guest: Guest): string      // Initiales pour avatar

// Statuts
getGuestStatusColor(guest: Guest): BadgeInfo // Couleur badge selon statut

// Filtres
hasActiveFilters(filters: GuestFilters): boolean
countActiveFilters(filters: GuestFilters): number
buildGuestQueryParams(filters: GuestFilters): URLSearchParams
```

## üîß Configuration

### Constantes principales
```typescript
PAGE_CONFIGS.GUESTS = {
  title: 'Guests Management',
  description: 'Consultez et g√©rez les informations des invit√©s...'
}

BREADCRUMBS.GUESTS = [
  { label: 'Accueil', href: '/home' },
  { label: 'Exploitation', href: '/home/exploitation' },
  { label: 'Guests' }
]

BREADCRUMBS.GUEST_DETAILS = (guestName?: string) => [
  // ... breadcrumbs avec nom dynamique
]
```

### Query Keys (TanStack Query)
```typescript
QUERY_KEYS.GUESTS(filters) // ['guests', 'list', filters]
QUERY_KEYS.GUEST_DETAILS(guestId) // ['guests', 'details', guestId]
```

## üöÄ Utilisation

### Import dans une autre page
```typescript
import { useGuests } from '@/app/home/exploitation/guests/hooks';

function MyComponent() {
  const { guests, isLoading, error } = useGuests(filters);
  // ...
}
```

### Ajout d'un nouveau filtre
1. Ajouter le champ dans `GuestFilters` (types/guest.ts)
2. Mettre √† jour `buildGuestQueryParams` (lib/guests-utils.ts)
3. Ajouter l'UI dans `GuestsFilters` component
4. Valider avec Zod si n√©cessaire (validation/guests.validation.ts)

### Personnalisation du cache
```typescript
// Dans config/constants.ts
CACHE_CONFIG.GUESTS = {
  staleTime: 30 * 1000, // 30 secondes au lieu d'1 minute
}
```

## üêõ Debugging

### Points de v√©rification
1. **Pas de donn√©es** : V√©rifier les filtres appliqu√©s
2. **Loading infini** : V√©rifier l'API /api/guestymirror/guests
3. **Erreur de format** : V√©rifier `guests-utils.ts`
4. **Cache persistant** : Invalider avec `invalidateGuests()`

### Validation des donn√©es
```typescript
// Utilise Zod pour valider
import { validateGuest, validateGuestsResponse } from './validation';

const validatedGuest = validateGuest(data);
```

### Logs disponibles
- API calls : Console via jhmhApiClient
- React Query : DevTools en d√©veloppement

## üìù Conventions de code

### Imports
```typescript
// 1. External imports
import { ... } from '@/components/...';
import { ... } from '@/lib/...';

// 2. Internal imports  
import { ... } from './components';
import { ... } from './hooks';
import { ... } from './config';
```

### Nommage
- **Composants** : PascalCase (`GuestsTable`)
- **Hooks** : camelCase avec `use` (`useGuests`)
- **Services** : camelCase avec verbe (`fetchJhmhGuests`)
- **Types** : PascalCase (`Guest`, `GuestFilters`)
- **Constantes** : SCREAMING_SNAKE_CASE (`PAGE_CONFIGS`)
- **Utils** : camelCase descriptif (`formatPhone`)

## üîÑ √âvolutions pr√©vues

1. **Export** : Export CSV/Excel de la liste
2. **Actions bulk** : S√©lection multiple et actions group√©es
3. **Historique** : Tracking des modifications
4. **Notes** : Syst√®me de notes et commentaires
5. **Tags** : Gestion avanc√©e des tags
6. **Int√©gration** : Liaison avec r√©servations

## ‚ö†Ô∏è Points d'attention apr√®s refactoring

1. **React Query** : Utilisation syst√©matique pour le data fetching
2. **Composants globaux** : Utilisation des √©tats LoadingVariants, ErrorVariants, NoDataVariants
3. **ResultsContainer standardis√©** : Utilise le composant global `@/components/dashboard/ResultsContainer` pour une UX uniforme
4. **Validation Zod** : Sch√©mas disponibles pour validation stricte
5. **Utils centralis√©s** : Toutes les fonctions de formatage dans lib/
6. **Architecture feature-based** : Module compl√®tement autonome
7. **Styles coh√©rents** : M√™me apparence que le dashboard accounting (LoadingVariants.DashboardSkeleton, NoDataVariants.SearchEmpty)

## üìö Ressources

- [TanStack Query Docs](https://tanstack.com/query)
- [Next.js App Router](https://nextjs.org/docs/app)
- [Zod Validation](https://zod.dev/)
- [Architecture Feature-Based](https://www.robinwieruch.de/react-folder-structure/)

*Status : Production Ready - API JHMH int√©gr√©e*