/**
 * Service pour la gestion des guests JHMH
 */

import { jhmhApiClient, ERROR_MESSAGES } from '@/lib/jhmh-api';

import type { ExternalGuestsResponse } from '../types';

/**
 * Paramètres de requête pour les guests
 */
export interface GuestQueryParams {
  page?: number;
  page_size?: number;
  q?: string;
  guest_id?: string;
  confirmation_code?: string;
}

/**
 * Réponse standardisée pour les services de guests
 */
export interface GuestsServiceResponse {
  success: boolean;
  data?: ExternalGuestsResponse;
  error?: string;
}

/**
 * Construit les paramètres de requête pour l'API guests
 */
function buildGuestQueryParams(params?: GuestQueryParams): URLSearchParams {
  const queryParams = new URLSearchParams();

  if (params?.page) queryParams.append('page', params.page.toString());
  if (params?.page_size)
    queryParams.append('page_size', params.page_size.toString());
  if (params?.q) queryParams.append('q', params.q);
  if (params?.guest_id) queryParams.append('guest_id', params.guest_id);
  if (params?.confirmation_code)
    queryParams.append('confirmation_code', params.confirmation_code);

  return queryParams;
}

/**
 * Récupère les guests depuis l'API JHMH
 */
export async function fetchJhmhGuests(
  params?: GuestQueryParams
): Promise<GuestsServiceResponse> {
  try {
    const queryParams = buildGuestQueryParams(params);
    const queryString = queryParams.toString();
    const url = `/api/guests${queryString ? `?${queryString}` : ''}`;

    const response = await jhmhApiClient.get<ExternalGuestsResponse>(url);

    return {
      success: true,
      data: response.data,
    };
  } catch (error) {
    console.error('Error fetching JHMH guests:', error);

    return {
      success: false,
      error: error instanceof Error ? error.message : ERROR_MESSAGES.UNKNOWN,
    };
  }
}

/**
 * Récupère un guest spécifique par son ID
 */
export async function fetchJhmhGuestById(
  guestId: string
): Promise<GuestsServiceResponse> {
  try {
    const response = await jhmhApiClient.get<ExternalGuestsResponse>(
      `/api/guests?guest_id=${guestId}`
    );

    return {
      success: true,
      data: response.data,
    };
  } catch (error) {
    console.error('Error fetching JHMH guest by ID:', error);

    return {
      success: false,
      error: error instanceof Error ? error.message : ERROR_MESSAGES.UNKNOWN,
    };
  }
}

// Note: Listing-related functions have been moved to the actifs module
// as they are not directly related to guest management
