'use client';

import { AlertCircle, WifiOff } from 'lucide-react';
import { useParams } from 'next/navigation';

import { DashboardLayout } from '@/components/dashboard/dashboard-layout';
import { Alert, AlertDescription, AlertTitle } from '@/components/ui/alert';
import { Button } from '@/components/ui/button';
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';
import {
  ReservationHeader,
  StayInformation,
  PaymentOverview,
  FinancialDetailsView,
  GuestInformation,
  ReservationTimeline,
  ReservationDetailsSkeleton,
  useReservationDetails,
} from '@/features/reservation-details';

export default function ReservationDetailsPage() {
  const params = useParams();
  const confirmationCode = params.confirmationCode as string;

  const breadcrumbs = [
    { label: 'Accueil', href: '/home' },
    { label: 'Réservations', href: '/home/exploitation/reservations' },
    { label: confirmationCode },
  ];

  const { reservation, isLoading, isError, error, refetch } =
    useReservationDetails({
      confirmationCode,
      queryParams: {
        include_audit_note: true,
      },
    });

  // Error state
  if (isError) {
    const isNotFound = error?.message === 'Réservation non trouvée';
    const hasNetworkError = error?.message?.includes('Network') ?? false;
    const hasFetchError = error?.message?.includes('fetch') ?? false;
    const isNetworkError = hasNetworkError || hasFetchError;

    let errorContent;

    if (isNetworkError) {
      errorContent = (
        <>
          <div className="rounded-full bg-destructive/10 p-4">
            <WifiOff className="h-12 w-12 text-destructive" />
          </div>
          <h2 className="text-2xl font-semibold">Erreur de connexion</h2>
          <p className="text-muted-foreground">
            Impossible de se connecter au serveur. Vérifiez votre connexion
            internet et réessayez.
          </p>
        </>
      );
    } else if (isNotFound) {
      errorContent = (
        <>
          <div className="rounded-full bg-muted p-4">
            <AlertCircle className="h-12 w-12 text-muted-foreground" />
          </div>
          <h2 className="text-2xl font-semibold">Réservation introuvable</h2>
          <p className="text-muted-foreground">
            La réservation avec le code <strong>{confirmationCode}</strong>{' '}
            n&apos;existe pas ou a été supprimée.
          </p>
        </>
      );
    } else {
      errorContent = (
        <>
          <div className="rounded-full bg-destructive/10 p-4">
            <AlertCircle className="h-12 w-12 text-destructive" />
          </div>
          <h2 className="text-2xl font-semibold">Une erreur est survenue</h2>
          <p className="text-muted-foreground">
            {error?.message ??
              'Impossible de charger les détails de la réservation.'}
          </p>
        </>
      );
    }

    return (
      <DashboardLayout breadcrumbs={breadcrumbs}>
        <div className="flex flex-col items-center justify-center min-h-[60vh] gap-6 p-8">
          <div className="flex flex-col items-center gap-4 max-w-md text-center">
            {errorContent}

            <div className="flex gap-3 mt-4">
              <Button variant="outline" onClick={() => window.history.back()}>
                Retour
              </Button>
              {!isNotFound && (
                <Button onClick={() => refetch()}>Réessayer</Button>
              )}
            </div>
          </div>
        </div>
      </DashboardLayout>
    );
  }

  // Loading state
  if (isLoading || !reservation) {
    return (
      <DashboardLayout breadcrumbs={breadcrumbs}>
        <div className="container mx-auto py-6">
          <ReservationDetailsSkeleton />
        </div>
      </DashboardLayout>
    );
  }

  // Success state with data
  return (
    <DashboardLayout breadcrumbs={breadcrumbs}>
      <div className="container mx-auto py-6">
        {/* Header section */}
        <ReservationHeader reservation={reservation} />

        {/* Main content with tabs */}
        <Tabs defaultValue="overview" className="mt-6">
          <TabsList className="grid w-full grid-cols-4 lg:w-[500px]">
            <TabsTrigger value="overview">Vue d&apos;ensemble</TabsTrigger>
            <TabsTrigger value="financial">Financier</TabsTrigger>
            <TabsTrigger value="timeline">Historique</TabsTrigger>
            <TabsTrigger value="technical">Technique</TabsTrigger>
          </TabsList>

          {/* Vue d'ensemble - Informations essentielles */}
          <TabsContent value="overview" className="space-y-6 mt-6">
            {/* Property and dates info */}
            <StayInformation reservation={reservation} />

            {/* Guest and payment grid */}
            <div className="grid gap-6 lg:grid-cols-2">
              {/* Guest information */}
              <GuestInformation reservation={reservation} />

              {/* Payment overview */}
              <PaymentOverview reservation={reservation} />
            </div>
          </TabsContent>

          {/* Financier - Décomposition tarifaire complète */}
          <TabsContent value="financial" className="mt-6">
            <FinancialDetailsView reservation={reservation} />
          </TabsContent>

          {/* Historique - Timeline des événements */}
          <TabsContent value="timeline" className="mt-6">
            <ReservationTimeline reservation={reservation} />
          </TabsContent>

          {/* Technique - Toutes les métadonnées et infos système */}
          <TabsContent value="technical" className="space-y-6 mt-6">
            {/* System identifiers */}
            <div className="grid gap-6 lg:grid-cols-2">
              <div className="space-y-4">
                <h3 className="text-lg font-semibold">Identifiants système</h3>
                <div className="space-y-3 text-sm">
                  {reservation.confirmationCode && (
                    <div className="flex justify-between">
                      <span className="text-muted-foreground">
                        Code confirmation
                      </span>
                      <span className="font-mono">
                        {reservation.confirmationCode}
                      </span>
                    </div>
                  )}

                  {reservation.REF && (
                    <div className="flex justify-between">
                      <span className="text-muted-foreground">
                        Référence interne
                      </span>
                      <span className="font-mono">{reservation.REF}</span>
                    </div>
                  )}

                  {reservation.reservation_id && (
                    <div className="flex justify-between">
                      <span className="text-muted-foreground">
                        ID Réservation
                      </span>
                      <span className="font-mono text-xs">
                        {reservation.reservation_id}
                      </span>
                    </div>
                  )}

                  {reservation.guest_id && (
                    <div className="flex justify-between">
                      <span className="text-muted-foreground">ID Client</span>
                      <span className="font-mono text-xs">
                        {reservation.guest_id}
                      </span>
                    </div>
                  )}

                  {reservation.listing_id && (
                    <div className="flex justify-between">
                      <span className="text-muted-foreground">ID Logement</span>
                      <span className="font-mono text-xs">
                        {reservation.listing_id}
                      </span>
                    </div>
                  )}
                </div>
              </div>

              {/* Statuses and metadata */}
              <div className="space-y-4">
                <h3 className="text-lg font-semibold">
                  Statuts et métadonnées
                </h3>
                <div className="space-y-3 text-sm">
                  {reservation.STATE && (
                    <div className="flex justify-between">
                      <span className="text-muted-foreground">
                        État principal
                      </span>
                      <span className="font-medium">{reservation.STATE}</span>
                    </div>
                  )}

                  {reservation.reservation_status && (
                    <div className="flex justify-between">
                      <span className="text-muted-foreground">
                        Statut réservation
                      </span>
                      <span className="font-medium">
                        {reservation.reservation_status}
                      </span>
                    </div>
                  )}

                  {reservation.statusReport && (
                    <div className="flex justify-between">
                      <span className="text-muted-foreground">
                        Statut rapport
                      </span>
                      <span className="font-medium">
                        {reservation.statusReport}
                      </span>
                    </div>
                  )}

                  {reservation.PLATFORM && (
                    <div className="flex justify-between">
                      <span className="text-muted-foreground">Plateforme</span>
                      <span className="font-medium">
                        {reservation.PLATFORM}
                      </span>
                    </div>
                  )}

                  {reservation.ota &&
                    reservation.ota !== reservation.PLATFORM && (
                      <div className="flex justify-between">
                        <span className="text-muted-foreground">OTA</span>
                        <span className="font-medium">{reservation.ota}</span>
                      </div>
                    )}
                </div>
              </div>
            </div>

            {/* Report information */}
            {(reservation.reportGenerationTimestamp ??
              reservation.reportId) && (
              <div className="space-y-4">
                <h3 className="text-lg font-semibold">
                  Informations du rapport
                </h3>
                <div className="grid gap-4 lg:grid-cols-2">
                  <div className="space-y-3 text-sm">
                    {reservation.reportGenerationTimestamp && (
                      <div className="flex justify-between">
                        <span className="text-muted-foreground">Généré le</span>
                        <span className="font-medium">
                          {new Date(
                            reservation.reportGenerationTimestamp
                          ).toLocaleString('fr-FR')}
                        </span>
                      </div>
                    )}

                    {reservation.reportId && (
                      <div className="flex justify-between">
                        <span className="text-muted-foreground">
                          ID Rapport
                        </span>
                        <span className="font-mono text-xs">
                          {reservation.reportId}
                        </span>
                      </div>
                    )}

                    {reservation.generatingUser && (
                      <div className="flex justify-between">
                        <span className="text-muted-foreground">
                          Généré par
                        </span>
                        <span className="font-medium">
                          {reservation.generatingUser}
                        </span>
                      </div>
                    )}
                  </div>

                  <div className="space-y-3 text-sm">
                    {reservation.constantsProfileUsed && (
                      <div className="flex justify-between">
                        <span className="text-muted-foreground">
                          Profil constantes
                        </span>
                        <span className="font-medium">
                          {reservation.constantsProfileUsed}
                        </span>
                      </div>
                    )}

                    {reservation.dataSourceOrigin && (
                      <div className="flex justify-between">
                        <span className="text-muted-foreground">
                          Source données
                        </span>
                        <span className="font-medium">
                          {reservation.dataSourceOrigin}
                        </span>
                      </div>
                    )}
                  </div>
                </div>
              </div>
            )}

            {/* Audit note */}
            {reservation.auditNote && (
              <Alert className="border-amber-200 bg-amber-50 dark:border-amber-800 dark:bg-amber-950">
                <AlertCircle className="h-4 w-4 text-amber-600" />
                <AlertTitle className="text-amber-800 dark:text-amber-200">
                  Note d&apos;audit
                </AlertTitle>
                <AlertDescription className="text-amber-700 dark:text-amber-300">
                  {reservation.auditNote}
                </AlertDescription>
              </Alert>
            )}

            {/* All dynamic fields */}
            <details className="space-y-4">
              <summary className="cursor-pointer text-sm font-medium text-muted-foreground hover:text-foreground">
                Voir toutes les données brutes
              </summary>
              <pre className="bg-muted rounded-lg p-4 text-xs overflow-x-auto">
                {JSON.stringify(reservation, null, 2)}
              </pre>
            </details>
          </TabsContent>
        </Tabs>
      </div>
    </DashboardLayout>
  );
}
